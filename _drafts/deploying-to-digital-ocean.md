---
layout: post
title: "Deploying An Express.js Application To Digital Ocean"
permalink: "deploying-an-expressjs-application-to-digital-ocean"
---

// TODO: Referral links at top and bottom

So you have written a Node.js web app using the Express.js framework and now you want to host it. In terms of pricing and configurability, I have not come across any host better than Digital Ocean. Starting at US$5/month, you can get full SSH access to a dedicated virtual Linux server, ready for Node.js hosting.

Consider using [my referral link](https://www.digitalocean.com/?refcode=69c47bb531c2) to create your Digital Ocean account to earn $10 in credit and support me at the same time.

Here's a short tutorial to get started with a very simple deployment. I will go through every step you need to take after you have an Express.js app running on `localhost`, from setting the Ubuntu server up to configuring ports using nginx. As of this time, I have a couple of production sites running this configuration, namely the [LegDay website](http://legday.co) and [Quibbler](http://quibbler.co).

Since there are many resources with in-depth information on all of these steps, this tutorial will try to remain as minimal as possible. I will try to guide you through the steps, not to explain what goes on behind each command.

<!--more-->

>Note: Most of this tutorial should apply to any server running a standard Ubuntu installation. As of this writing, I am running Ubuntu 14.04 on the server, but the same instructions should apply even several years from now.

## Prerequisites

For this tutorial, I assume that you are running a Unix-based OS on your local computer. I am running OS X Yosemite. However, anything that can be used for SSH access into the server should work.

Obviously, you need an Express.js app to deploy. The default app generated by [express-generator](http://expressjs.com/starter/generator.html) should work, if you just want to try things out. Basically, you need something configured so that when you run `npm start` in its directory, it starts hosting the app on a local server in your computer.

This guide won't cover the process of hosting a database on this server. I assume your app manages its database stuff (if any) in whatever way you prefer.

>Tip: This tutorial works for a Socket.IO powered real-time Express app as well.

You will require a Digital Ocean account. I would appreciate if you used [my referral link](https://www.digitalocean.com/?refcode=69c47bb531c2) to create your account. It will get you $10 credit automatically, while supporting me at the same time.

It would be nice to have some experience around the Unix command line, since we will be SSH'ing into the server and using it headless (without a screen) and remotely. 

>Note: You do not need to travel to where your server is.

## The Server

Time to spin up a simple Digital Ocean Droplet (server), running the latest Ubuntu. You may use another distribution of Linux if you wish, but there is no guarantee that all of the following instructions will apply to your system. I highly recommend Ubuntu to keep things simple.

<img src="/assets/express-do-config.png" alt="Digital Ocean config" style="float: center; margin: auto;">

Start by clicking the green Create Droplet button from anywhere on the Digital Ocean dashboard (after you register and log in).

1. You can name the Droplet anything you want. I intend to use mine for any future projects, so I went with AntrikshyWeb.
2. Select your preferred pricing. The lowest tier is not bad at all. It can handle a small website very well. I'd recommend switching to a higher tier only if you feel like your server is not able to handle the traffic.
3. You can select any of the Droplet locations. It's always a good idea to pick one close to where you expect most of your visitors from.
4. Select the latest version of Ubuntu (64-bits) as the OS. As I mentioned earlier, 14.04 is the current version at the time of writing. In the Applications tab, select the latest version of Node.js to be pre-installed. For this simple setup, this is all you need.
5. I highly recommend creating an SSH key on your current computer and adding the public key to the server at this time. [This is a nice tutorial](https://help.github.com/articles/generating-ssh-keys/) to follow. Instead of adding the public key to your GitHub account, copy it into Digital Ocean's form. This way, no root password is generated, and only your computer can access the server via SSH. Of course you can change SSH settings around later.

Then create the Droplet. It should be ready with a fresh Ubuntu and Node.js installation within seconds. You can ask any questions you have at this point in the comments below. Every single one of them will be read.

### Digital Ocean Pricing Explained

If you're wondering how the Digital Ocean hourly and monthly pricing schemes work, it's pretty simple to understand. They charge you by hour, so you can immediately shut off the server without being charged for the entire month. The monthly fee is a cap for this hourly fee. Once you hit this cap, you are not charged per hour for the rest of the monthly billing cycle.

### First-Time Setup

With this fresh Ubuntu installation, you will need to perform a few more steps to get things snugly fit into place and running smoothly.

It is not a very nice idea to run things in production on the `root` user account. Since it has all possible permissions, it can be dangerous to use it for day-to-day purposes. You should create a standard user account for hosting this app (and perhaps all your other web stuff).

Now, connect to your server from your computer using the following Terminal command.

{% highlight bash %}
ssh root@IP_ADDRESS
{% endhighlight %}

Replace `IP_ADDRESS` with your server's IP address, which should be provided by Digital Ocean after you create it. Now you are logged in as the root user I mentioned before. Set up a new user account as follows.

{% highlight bash %}
adduser yourname
{% endhighlight %}

Replace `yourname` with any username, of course. Answer the questions it asks. You can leave a lot of them empty, since this is just a web hosting user and the details won't be seen by anyone else. You also want to give this user `sudo` access, meaning the ability to run stuff as root by entering its password whenever needed.

{% highlight bash %}
adduser yourname sudo
{% endhighlight %}

Now that you have a safe, non-root user account ready, you should log into the server using that account. Press Ctrl+D or type `logout` to end the connection from your local computer. Then log in once again.

{% highlight bash %}
ssh yourname@IP_ADDRESS
{% endhighlight %}

When deploying a Node.js app on a production server, it is also a good idea to set the `NODE_ENV` environment variable to `production`. Many frameworks (including Express) may self-configure some behavior (like hiding error traces from users) by looking at this environment variable.

>Tip: Environment variables are simply some variables that are set globally at the command line and accessible from any program that is run on that computer. Type `printenv` to see all currently set environment variables.

To set this variable, edit the `.profile` file in your home directory.

{% highlight bash %}
nano ~/.profile
{% endhighlight %}

Add the line `export NODE_ENV="production"` to the bottom of this file. Press Ctrl+X to save.

Let's move onto some fun stuff.

## Push & Test

It's time to push the code up to your production server. You can do this in two ways. Since I use GitHub to open source my projects anyway, I prefer the Git method. You can scroll down to the simpler SSH file transfer method if you do not use Git for source control and/or do not have a cloud host that you push your repositories to.

### Transfer Via Git

Simply `push` your project's Git repo to your cloud service (GitHub, BitBucket or whatever your company/institution uses) using `git push origin` as usual. Then log into your Droplet and `clone` the repo.

{% highlight bash %}
ssh yourname@IP_ADDRESS

git clone CLONE_URL

cd projectname
{% endhighlight %}

Replace `CLONE_URL` above with the clone URL provided by your Git server. GitHub has a URL in the sidebar of your project's page.

### Transfer Via Manual File Transfer

To manually upload your files directly from your local computer over SSH, follow these instructions.

Log out of SSH and `cd` to the parent directory containing your main Node.js app folder (the folder above the one containing `package.json`) on your local computer.

{% highlight bash %}
scp ./projectname yourname@IP_ADDRESS:~
{% endhighlight %}

You will be prompted for `yourname`'s password and the entire project folder to `yourname`'s home directory.

### Testing The Server

Just as a sanity check, run your Express app just like you did on your local computer while developing it and see if it is accessible from your computer over the web.

{% highlight bash %}
cd projectname

npm install

npm start
{% endhighlight %}

If the app seems to start up in the same way as it does locally, open up a web browser on your local computer and visit `IP_ADDRESS:3000` directly. Replace `IP_ADDRESS` with your Droplet's IP and `3000` with any custom port you may have defined (Express defaults to 3000). If something does not work, fix it. I can't see why it would give you any issues at this stage, but it's totally dependent on your app.

At this point, your web app should show up in the web browser at this address. Once you have verified this, you can close the server using Ctrl+C as usual.

## Create An Upstart Service

Now that we know our Express app runs on this server, it is a nice idea to set it up as an Ubuntu service. This ensures that the app is always running. It makes sure that it starts as soon as the server boots up. This way, in the unlikely event that Digital Ocean goes offline, your website will come right back up as soon as the server boots back up.



## Configure Ports
## Set Up Domain
## Further Steps

// TODO: SSH keys etc
